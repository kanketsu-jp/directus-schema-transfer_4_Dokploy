= Directusのコレクションやファイル構成を簡単に移管する方法
リポジトリ名: directus-schema-transfer
:toc:
:toclevels: 2
:sectnums:

== 概要

本リポジトリは、Directusのスキーマ（コレクションやフィールド）およびファイル構成（フォルダー設定）を、あるDirectus環境（ソース）から別のDirectus環境（ターゲット）へ自動的に移管するためのBashスクリプトを提供します。  
スクリプトは以下の処理を実施します：
* ソースコンテナ内の既存スナップショットファイル（/tmp/schema.yaml）を削除し、常に最新のスナップショットを取得
* ソース環境から新しいスナップショットを取得し、そのファイルをホストにコピー、さらにターゲット環境のコンテナへ転送して適用
* ソース環境のアップロードボリューム（ファイルストレージ）をアーカイブし、ターゲット環境へ展開
* VPSホスト上にインストール済みの PostgreSQL クライアントを使用して、directus_folders テーブルのデータ（フォルダー構造）をエクスポート・インポート
* 必要に応じて、ターゲットコンテナの再起動を実施
* 最後に、アップロードデータのバックアップファイルの保存場所を表示

== 特徴

* **自動クリーンアップ:** ソースコンテナ内の /tmp/schema.yaml を削除し、新しいスナップショットで上書きするため、古いバックアップファイルが残りません。
* **スキーマ移管:** 最新のスナップショットを取得し、ターゲット環境に適用します。
* **ファイル・フォルダ移管:** アップロードボリュームのコピーに加え、VPSホスト上の PostgreSQL クライアントを利用して directus_folders テーブルのデータを移管します。
* **デバッグログ:** DEBUG_MODE を有効にすると詳細なログが出力され、トラブルシューティングが容易になります。
* **環境検証:** ユーザー入力の識別子から生成したコンテナが存在するかを事前に確認します。
* **非破壊性:** ソース環境に変更を加えず、ターゲット環境にのみ変更を適用します。
* **言語切替:** 環境変数 LANG を設定（例：LANG=ja）することで、スクリプトのメッセージを日本語表示に切り替えられます。

== セットアップと使用方法

=== 1. 前提条件

* Docker がインストールされ、利用可能であること。
* Directus が Docker コンテナ上で稼働していること。
* 各コンテナには PostgreSQL アクセス用の環境変数 `DB_PASSWORD` が正しく設定されていること。
* **VPSホストには、PostgreSQL クライアントがインストールされている必要があります。**

==== 1.1 VPS上での PostgreSQL クライアントのインストール方法

- **Debian/Ubuntu 系の場合:**

[source, bash]
----
sudo apt-get update
sudo apt-get install -y postgresql-client
----

- **CentOS/RedHat 系の場合:**

[source, bash]
----
sudo yum install -y postgresql
----

*これらのコマンドで、ホスト側（VPS）に PostgreSQL クライアントがインストールされます。*

*移管前にソースおよびターゲット環境のバックアップを必ず取得してください。*

=== 2. リポジトリのクローン

1. ホームディレクトリに移動し、本リポジトリをクローンします:
[source, bash]
----
cd ~
git clone --branch japanese --single-branch https://github.com/yourusername/directus-schema-transfer.git
----
2. クローン後、リポジトリのディレクトリに移動します:
[source, bash]
----
cd directus-schema-transfer
----

=== 3. スクリプトの実行

1. スクリプトに実行権限を付与します:
[source, bash]
----
chmod +x directus-migrate.sh
----
2. スクリプトを実行します:
[source, bash]
----
./directus-migrate.sh
----
実行中、以下の入力が求められます：
* 開発環境の識別子 (例: 123ec1)
* 本番環境の識別子 (例: 61a680)
* 本番環境コンテナの再デプロイの有無（必要なら `y`、不要なら `n`）
* さらに、ソースおよびターゲットのデータベース接続情報として、ソースDBホスト、ターゲットDBホスト、DBユーザー、DBパスワード、DB名を入力してください。

また、スクリプトのメッセージを日本語で表示する場合は、実行前に `LANG=ja` を設定してください:
[source, bash]
----
LANG=ja ./directus-migrate.sh
----

== 注意点

* スクリプト実行前に、必ず各環境のバックアップを取得してください。
* 本スクリプトは、Directus のスキーマおよび画像のファイル構成（directus_foldersテーブル）のみを移管します。
  - 画像ファイル自体はアップロードボリュームのコピーで移管されます。
  - 記事などのコレクションアイテムは移管されません。
* スクリプトは、既存のスナップショットやバックアップファイルを自動的に削除・上書きし、不要なゴミが残らないように設計されています。

== 議論とフィードバック

本リポジトリは、Directus の設定移管を簡単に実現する方法を共有し、同じ手法を必要とする方々の参考になればと思います。  
もし、Dokploy や Directus の構造をより活かした、さらに良い移管方法があれば、GitHub Issues や Pull Request でご提案ください。

== まとめ

この手順書に従い、ホームディレクトリに *directus-migrate.sh* をクローン・実行することで、Directus のスキーマおよび画像のファイル構成を安全かつ効率的に移管できます。  
初回実装時には、対象コンテナの存在確認やデータベース接続情報の入力も行われるため、環境に合わせた調整が容易です。

== ライセンス

[例: MIT License]

== 貢献

改善や提案は大歓迎です。GitHub Issues または Pull Request でご連絡ください。

== お問い合わせ

ご質問やフィードバックは、GitHub Issues をご利用ください。
